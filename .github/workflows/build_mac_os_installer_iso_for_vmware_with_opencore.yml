name: Build macOS Installer ISO for VMware with OpenCore

on:
  workflow_dispatch:
    inputs:
      macos:
        description: "macOS Version"
        required: true
        type: choice
        options:
          - Tahoe
          - Sequoia
          - Sonoma
          - Ventura
          - Monterey
          - Big_Sur
          - Catalina
          - Mojave
          - High_Sierra
          - Sierra
          - El_Capitan
          - Yosemite
          - Mavericks
          - Mountain_Lion
          - Lion

permissions:
  contents: write

jobs:
  build:
    runs-on: macos-15-intel
    timeout-minutes: 480

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v5

      - name: Install dependencies
        run: |
          brew update
          brew install qemu unzip wget

      # ===============================
      # Fetch OpenCore RELEASE (Retry 5x)
      # ===============================
      - name: Fetch OpenCore
        run: |
          set -e
          SUCCESS=false
          for i in {1..5}; do
            echo "Attempt $i to fetch OpenCore..."
            if wget -O OpenCore.zip https://github.com/acidanthera/OpenCorePkg/releases/download/0.9.9/OpenCore-0.9.9-RELEASE.zip; then
              SUCCESS=true && break
            fi
            echo "Download failed, retrying in 10s..."
            sleep 10
          done
          if [ "$SUCCESS" = false ]; then exit 1; fi
          
          unzip -o OpenCore.zip
          mkdir -p OC/EFI
          cp -R X64/EFI/* OC/EFI/
          cp Docs/Sample.plist OC/EFI/OC/config.plist
          
          CFG="OC/EFI/OC/config.plist"
          /usr/libexec/PlistBuddy -c "Set :PlatformInfo:Generic:SystemProductName iMacPro1,1" "$CFG"
          /usr/libexec/PlistBuddy -c "Set :PlatformInfo:Generic:SystemUUID $(uuidgen)" "$CFG"

      # ===============================
      # Build macOS Installer ISO (Retry 5x for Busy Disks)
      # ===============================
      - name: Build Installer ISO
        run: |
          set -e
          VER="${{ inputs.macos }}"
          VER_NAME=$(echo "$VER" | sed 's/_/ /g')
          WORK="work-$VER"
          mkdir -p "$WORK"
          cd "$WORK"

          # 1. Fetch Installer with Retry
          FULL_VER=$(softwareupdate --list-full-installers | grep "$VER_NAME" | head -n 1 | awk -F 'Version: ' '{print $2}' | awk '{print $1}' | tr -d ',')
          [ -z "$FULL_VER" ] && FULL_VER="15.2" 
          
          APP="/Applications/Install macOS $VER_NAME.app"
          SUCCESS_DL=false
          for i in {1..5}; do
            echo "Attempt $i to fetch $VER_NAME installer..."
            sudo softwareupdate --fetch-full-installer --full-installer-version "$FULL_VER" && SUCCESS_DL=true && break
            sleep 30
          done
          if [ "$SUCCESS_DL" = false ]; then exit 1; fi

          # 2. Create Media DMG
          APP_SIZE=$(du -sm "$APP" | awk '{print $1}')
          DMG_SIZE=$((APP_SIZE + 8192))
          hdiutil create -size "${DMG_SIZE}m" -layout SPUD -fs "HFS+J" -volname "Install_macOS" installer.dmg

          # 3. Create Install Media
          hdiutil attach installer.dmg -mountpoint /Volumes/Install_macOS
          sudo "$APP/Contents/Resources/createinstallmedia" --volume /Volumes/Install_macOS --nointeraction

          # 4. Critical Detach Logic with Retry (Handles "Resource Busy")
          SUCCESS_DETACH=false
          for i in {1..5}; do
            echo "Attempt $i to detach installer disk..."
            sleep 20
            DEV=$(hdiutil info | grep "Install macOS $VER_NAME" | awk '{print $1}' | head -n 1)
            if [ -n "$DEV" ]; then
              diskutil unmountDisk force "$DEV" || true
              hdiutil detach "$DEV" -force && SUCCESS_DETACH=true && break
            else
              SUCCESS_DETACH=true && break
            fi
          done
          if [ "$SUCCESS_DETACH" = false ]; then exit 1; fi
          
          # 5. Conversion and Space Cleanup
          hdiutil convert installer.dmg -format UDTO -o temp_installer
          mv temp_installer.cdr installer.iso
          rm installer.dmg
          sudo rm -rf "$APP"

      # ===============================
      # Create OpenCore Disk (Retry 5x for Mount)
      # ===============================
      - name: Create OpenCore Disk
        run: |
          set -e
          WORK="work-${{ inputs.macos }}"
          cd "$WORK"

          hdiutil create -size 200m -fs "MS-DOS FAT32" -volname "EFI" oc.dmg
          RAW_DEV=$(hdiutil attach -nomount oc.dmg | head -n 1 | awk '{print $1}')
          
          EFI_DEV="${RAW_DEV}s1"
          [ ! -e "$EFI_DEV" ] && EFI_DEV="$RAW_DEV"
          
          MOUNT_PATH=""
          for i in {1..5}; do
            echo "Mount attempt $i for OpenCore EFI..."
            diskutil mount "$EFI_DEV" && sleep 5
            MOUNT_PATH=$(diskutil info "$EFI_DEV" | grep "Mount Point" | awk -F': ' '{print $2}' | xargs)
            if [ -n "$MOUNT_PATH" ]; then break; fi
            sleep 10
          done

          if [ -z "$MOUNT_PATH" ]; then echo "EFI failed to mount"; exit 1; fi

          sudo mkdir -p "$MOUNT_PATH/EFI"
          sudo cp -R ../OC/EFI/* "$MOUNT_PATH/EFI/"
          
          diskutil unmount "$EFI_DEV"
          hdiutil detach "$RAW_DEV"
          qemu-img convert -f raw -O vmdk oc.dmg OpenCore.vmdk
          rm oc.dmg

      # ===============================
      # Finalize VMX & Upload
      # ===============================
      - name: Finalize & Upload
        run: |
          WORK="work-${{ inputs.macos }}"
          cd "$WORK"
          # VMX Content
          printf '%s\n' \
            'config.version = "8"' \
            'virtualHW.version = "20"' \
            'guestOS = "darwin64"' \
            'firmware = "efi"' \
            'memsize = "4096"' \
            'numvcpus = "4"' \
            'smc.present = "TRUE"' \
            'sata0:0.fileName = "OpenCore.vmdk"' \
            'sata0:1.fileName = "installer.iso"' \
            'sata0:1.deviceType = "cdrom-image"' \
            > macOS.vmx
          shasum -a 256 installer.iso > installer.iso.sha256

      - name: Upload Artifacts
        uses: actions/upload-artifact@v5
        with:
          name: macOS-${{ inputs.macos }}-VMware
          path: work-${{ inputs.macos }}/**
